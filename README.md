# Nomad Enterprise HVD on Azure VMs

Terraform module aligned with HashiCorp Validated Designs (HVD) to deploy Nomad Enterprise on Microsoft Azure using Azure Virtual Machines.

## Prerequisites

### General

- Knowledge of Terraform and Azure
- Terraform CLI `>= 1.9` installed on client/workstations
- An Azure account with permissions to provision [resources](#resources) via Terraform
- `git` CLI and Visual Studio Code recommended on workstations

### Networking

- Azure Virtual Network (VNet) and subnets:
  - A subnet for the Virtual Machines (compute)
  - Optional subnet for the Load Balancer

>üìù Note: Specify at least two subnets for high availability.

#### Security groups

- This module will create network security groups (NSGs) for Nomad Virtual Machines.
- Define CIDR ranges for Nomad access using the input variable `cidr_allow_ingress_nomad`.

### TLS certificates

TLS certificates for Nomad have very specific requirements for server and client nodes. [Nomad Agent Certificates](https://developer.hashicorp.com/nomad/tutorials/transport-security/security-enable-tls#agent-certificates). Let's Encrypt certificates cannot be used for Nomad due to the specific requirements. This module has the option to not enable TLS with `nomad_tls_enabled`; however, this should only be used in lab environments.

- TLS certificate (_e.g._ `cert.pem`) and private key (_e.g._ `privkey.pem`) for the Nomad web UI, in PEM format.
  - TLS private key must **not** be password-protected.
- TLS certificate authority (CA) bundle (_e.g._ `ca_bundle.pem`) in PEM format.

>üìù Store these TLS files as Azure Key Vault secrets to securely manage your certificates.

### Gossip encryption

Gossip encryption is required for this module. A Gossip encryption Key can be generated by the Nomad CLI with `nomad operator gossip keyring generate`. Create this before deploying the module and store it in Azure Key Vault.

### Secrets management

The following secrets must be stored in **Azure Key Vault** to bootstrap the Nomad server deployment:

- **Nomad license** - text string used for Nomad Enterprise licensing - This is only needed for Nomad server deployment
- **Nomad Gossip encryption Key** - text string generated by `nomad operator gossip keyring generate` - This is only needed for Nomad server deployment
- **Nomad TLS certificate and private key** - stored as base64-encoded PEM secrets in Azure Key Vault

>üìù See the Nomad documentation for more details on securing these secrets in Azure Key Vault.

## Usage

1. Configure the [prerequisites](#prerequisites).

1. In the `examples` directory, you will find subdirectories with ready-made Terraform configurations for deploying this module. Select an example that matches your use case, and copy its contents to a new directory.

    >üìù Example structure for managing multiple Nomad deployments:

    ```pre
    .
    ‚îî‚îÄ‚îÄ environments
        ‚îú‚îÄ‚îÄ production
        ‚îÇ   ‚îú‚îÄ‚îÄ backend.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
        ‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars
        ‚îÇ   ‚îî‚îÄ‚îÄ variables.tf
        ‚îî‚îÄ‚îÄ sandbox
            ‚îú‚îÄ‚îÄ backend.tf
            ‚îú‚îÄ‚îÄ main.tf
            ‚îú‚îÄ‚îÄ outputs.tf
            ‚îú‚îÄ‚îÄ terraform.tfvars
            ‚îî‚îÄ‚îÄ variables.tf
    ```

    >üìù This example has two separate Nomad deployments: one for a `sandbox` environment and one for a `production` environment.

1. (Optional) If using Azure Blob Storage for remote state, configure the `backend.tf` file with custom values.

1. Update the `terraform.tfvars` file with your custom values, then run `terraform init`, `terraform plan`, and `terraform apply`.

1. After `terraform apply` completes successfully, connect to the Nomad VM instance shell using SSH or Azure Bastion to monitor the cloud-init logs:

    **Connecting to the VM instance:**

    ```sh
    ssh -i /path/to/ssh_private_key azureuser@<vm-public-ip>
    ```

    **Viewing logs:**

    ```sh
    tail -f /var/log/nomad-cloud-init.log
    ```

1. Once the installation finishes, verify the health of the Nomad cluster by checking the Nomad Web UI or by running:

    ```sh
    nomad server members
    ```

1. If `nomad_acl_enabled` is `true`, the Nomad cluster will need to be bootstrapped with the command `nomad acl bootstrap`. This will generate a bootstrap token that can be used to log in to the CLI or UI.

## Docs

Additional documentation for managing and customizing your Nomad deployment is available in the `docs` folder:

- Nomad version upgrades
- Nomad TLS certificate rotation
- Nomad configuration settings
- Nomad deployment customizations

## Module support

This open source software is maintained by the HashiCorp Technical Field Organization, independently of our enterprise products. While our Support Engineering team provides dedicated support for our enterprise offerings, this open source software is not included.

- For help using this open source software, please engage your account team.
- To report bugs/issues with this open source software, please open them directly against this code repository using the GitHub issues feature.

Please note that there is no official Service Level Agreement (SLA) for support of this software as a HashiCorp customer. This software falls under the definition of Community Software/Versions in your Agreement. We appreciate your understanding and collaboration in improving our open source projects.

<!-- BEGIN_TF_DOCS -->
## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.9 |
| <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) | >= 3.70.0 |

## Providers

| Name | Version |
|------|---------|
| <a name="provider_azurerm"></a> [azurerm](#provider\_azurerm) | >= 3.70.0 |

## Resources

| Name | Type |
|------|------|
| [azurerm_dns_a_record.nomad_alias_record](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/dns_a_record) | resource |
| [azurerm_dns_zone.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/dns_zone) | resource |
| [azurerm_key_vault.nomad_keyvault](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/key_vault) | resource |
| [azurerm_lb.nomad_lb](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb) | resource |
| [azurerm_lb_backend_address_pool.nomad_backend_pool](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_backend_address_pool) | resource |
| [azurerm_lb_probe.nomad_probe](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_probe) | resource |
| [azurerm_lb_rule.nomad_lb_rule_4646](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/lb_rule) | resource |
| [azurerm_linux_virtual_machine_scale_set.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/linux_virtual_machine_scale_set) | resource |
| [azurerm_network_interface.nomad_lb_nic](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface) | resource |
| [azurerm_network_interface_security_group_association.lb_nsg_association](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_interface_security_group_association) | resource |
| [azurerm_network_security_group.lb_nsg](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) | resource |
| [azurerm_network_security_group.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/network_security_group) | resource |
| [azurerm_public_ip.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) | resource |
| [azurerm_public_ip.nomad_frontend_ip](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/public_ip) | resource |
| [azurerm_resource_group.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) | resource |
| [azurerm_role_assignment.nomad_vm_reader_role](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) | resource |
| [azurerm_user_assigned_identity.nomad_vm_identity](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/user_assigned_identity) | resource |
| [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) | data source |
| [azurerm_image.custom](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/image) | data source |
| [azurerm_resource_group.nomad](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) | data source |
| [azurerm_resource_group.nomad_rg](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/resource_group) | data source |
| [azurerm_subnet.nomad_subnet](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subnet) | data source |
| [azurerm_subscription.primary](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/subscription) | data source |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_friendly_name_prefix"></a> [friendly\_name\_prefix](#input\_friendly\_name\_prefix) | Friendly name prefix used for uniquely naming Azure resources. | `string` | n/a | yes |
| <a name="input_location"></a> [location](#input\_location) | Azure region to use for this deployment. | `string` | n/a | yes |
| <a name="input_nomad_client"></a> [nomad\_client](#input\_nomad\_client) | Enable the Nomad client agent. | `bool` | n/a | yes |
| <a name="input_nomad_datacenter"></a> [nomad\_datacenter](#input\_nomad\_datacenter) | Specifies the data center of the local agent. | `string` | n/a | yes |
| <a name="input_nomad_server"></a> [nomad\_server](#input\_nomad\_server) | Enable the Nomad server agent. | `bool` | n/a | yes |
| <a name="input_resource_group_name"></a> [resource\_group\_name](#input\_resource\_group\_name) | Name of Azure resource group to create or name of existing resource group to use (if `create_resource_group` is `false`). | `string` | n/a | yes |
| <a name="input_ssh_key_name"></a> [ssh\_key\_name](#input\_ssh\_key\_name) | Name of the SSH key for VM access, already registered in Azure. | `string` | n/a | yes |
| <a name="input_subnet_id"></a> [subnet\_id](#input\_subnet\_id) | Azure subnet ID for Nomad instance network interface. | `string` | n/a | yes |
| <a name="input_vnet_id"></a> [vnet\_id](#input\_vnet\_id) | ID of the Azure VNet where resources are deployed. | `string` | n/a | yes |
| <a name="input_additional_package_names"></a> [additional\_package\_names](#input\_additional\_package\_names) | List of additional repository package names to install on the VMs | `set(string)` | `[]` | no |
| <a name="input_admin_password"></a> [admin\_password](#input\_admin\_password) | Admin password for VM instance. | `string` | `"testPassword1234!"` | no |
| <a name="input_admin_username"></a> [admin\_username](#input\_admin\_username) | Admin username for VM instance. | `string` | `"ubuntu"` | no |
| <a name="input_associate_public_ip"></a> [associate\_public\_ip](#input\_associate\_public\_ip) | Whether to associate public IPs with the Nomad cluster VMs. | `bool` | `false` | no |
| <a name="input_autopilot_health_enabled"></a> [autopilot\_health\_enabled](#input\_autopilot\_health\_enabled) | Perform autopilot health checks on Nomad server nodes at boot. | `bool` | `true` | no |
| <a name="input_cidr_allow_ingress_nomad"></a> [cidr\_allow\_ingress\_nomad](#input\_cidr\_allow\_ingress\_nomad) | CIDR ranges allowed ingress on port 443/80 for Nomad server/load balancer. | `list(string)` | <pre>[<br/>  "0.0.0.0/0"<br/>]</pre> | no |
| <a name="input_cni_version"></a> [cni\_version](#input\_cni\_version) | Version of CNI plugin to install. | `string` | `"1.6.0"` | no |
| <a name="input_common_tags"></a> [common\_tags](#input\_common\_tags) | Map of common tags for taggable Azure resources. | `map(string)` | `{}` | no |
| <a name="input_create_dns_nomad_record"></a> [create\_dns\_nomad\_record](#input\_create\_dns\_nomad\_record) | Boolean to create DNS A Record for Nomad in Azure DNS. | `bool` | `false` | no |
| <a name="input_create_load_balancer"></a> [create\_load\_balancer](#input\_create\_load\_balancer) | Boolean to create an Azure Load Balancer for Nomad. | `bool` | `true` | no |
| <a name="input_create_resource_group"></a> [create\_resource\_group](#input\_create\_resource\_group) | Boolean to create a new Azure resource group for this deployment. Set to `false` if you want to use an existing resource group. | `bool` | `false` | no |
| <a name="input_disk_size_gb"></a> [disk\_size\_gb](#input\_disk\_size\_gb) | Size of OS disk for Nomad VMs in GB. | `number` | `50` | no |
| <a name="input_disk_type"></a> [disk\_type](#input\_disk\_type) | Disk type for Nomad VMs. Options: `Standard_LRS`, `Premium_LRS`, etc. | `string` | `"Standard_LRS"` | no |
| <a name="input_frontend_ip_config_name"></a> [frontend\_ip\_config\_name](#input\_frontend\_ip\_config\_name) | The name of the frontend IP configuration to which the rule is associated. | `string` | `"PublicIPAddress"` | no |
| <a name="input_instance_count"></a> [instance\_count](#input\_instance\_count) | Instance count for Azure Scale Set. | `number` | `2` | no |
| <a name="input_lb_is_internal"></a> [lb\_is\_internal](#input\_lb\_is\_internal) | Create an internal (private) Azure Load Balancer. | `bool` | `true` | no |
| <a name="input_nomad_acl_enabled"></a> [nomad\_acl\_enabled](#input\_nomad\_acl\_enabled) | Enable ACLs for Nomad. | `bool` | `true` | no |
| <a name="input_nomad_architecture"></a> [nomad\_architecture](#input\_nomad\_architecture) | Architecture of the Nomad binary to install. | `string` | `"amd64"` | no |
| <a name="input_nomad_dns_zone_name"></a> [nomad\_dns\_zone\_name](#input\_nomad\_dns\_zone\_name) | Azure DNS zone name to create the Nomad A record. | `string` | `null` | no |
| <a name="input_nomad_fqdn"></a> [nomad\_fqdn](#input\_nomad\_fqdn) | Fully qualified domain name of the Nomad Cluster. This name should resolve to the load balancer IP address. | `string` | `null` | no |
| <a name="input_nomad_gossip_encryption_key_secret_id"></a> [nomad\_gossip\_encryption\_key\_secret\_id](#input\_nomad\_gossip\_encryption\_key\_secret\_id) | ID of Azure Key Vault secret for Nomad gossip encryption key. | `string` | `null` | no |
| <a name="input_nomad_license_secret_id"></a> [nomad\_license\_secret\_id](#input\_nomad\_license\_secret\_id) | ID of Azure Key Vault secret for Nomad license file. | `string` | `null` | no |
| <a name="input_nomad_location"></a> [nomad\_location](#input\_nomad\_location) | Specifies the region of the local agent. Defaults to the Azure region if null. | `string` | `null` | no |
| <a name="input_nomad_nodes"></a> [nomad\_nodes](#input\_nomad\_nodes) | Number of Nomad nodes to deploy. | `number` | `6` | no |
| <a name="input_nomad_tls_ca_bundle_secret_id"></a> [nomad\_tls\_ca\_bundle\_secret\_id](#input\_nomad\_tls\_ca\_bundle\_secret\_id) | ID of Azure Key Vault secret for private/custom TLS Certificate Authority (CA) bundle in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_tls_cert_secret_id"></a> [nomad\_tls\_cert\_secret\_id](#input\_nomad\_tls\_cert\_secret\_id) | ID of Azure Key Vault secret for Nomad TLS certificate in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_tls_enabled"></a> [nomad\_tls\_enabled](#input\_nomad\_tls\_enabled) | Enable TLS for Nomad. | `bool` | `true` | no |
| <a name="input_nomad_tls_privkey_secret_id"></a> [nomad\_tls\_privkey\_secret\_id](#input\_nomad\_tls\_privkey\_secret\_id) | ID of Azure Key Vault secret for Nomad TLS private key in PEM format. Secret must be stored as a base64-encoded string. | `string` | `null` | no |
| <a name="input_nomad_ui_enabled"></a> [nomad\_ui\_enabled](#input\_nomad\_ui\_enabled) | Enable the Nomad UI. | `bool` | `true` | no |
| <a name="input_nomad_upstream_servers"></a> [nomad\_upstream\_servers](#input\_nomad\_upstream\_servers) | List of Nomad server addresses to join the Nomad client with. | `list(string)` | `null` | no |
| <a name="input_nomad_upstream_tag_key"></a> [nomad\_upstream\_tag\_key](#input\_nomad\_upstream\_tag\_key) | String of the tag key the Nomad client should look for in AWS to join with. Only needed for auto-joining the Nomad client. | `string` | `null` | no |
| <a name="input_nomad_upstream_tag_value"></a> [nomad\_upstream\_tag\_value](#input\_nomad\_upstream\_tag\_value) | String of the tag value the Nomad client should look for in AWS to join with. Only needed for auto-joining the Nomad client. | `string` | `null` | no |
| <a name="input_nomad_version"></a> [nomad\_version](#input\_nomad\_version) | Version of Nomad to install. | `string` | `"1.9.0+ent"` | no |
| <a name="input_permit_all_egress"></a> [permit\_all\_egress](#input\_permit\_all\_egress) | Allow unrestricted egress on cluster nodes. Additional rules may be required if disabled. | `bool` | `true` | no |
| <a name="input_ssh_public_key"></a> [ssh\_public\_key](#input\_ssh\_public\_key) | SSH public key for bastion VM instance. | `string` | `null` | no |
| <a name="input_vm_custom_image_name"></a> [vm\_custom\_image\_name](#input\_vm\_custom\_image\_name) | Name of custom VM image to use for VMSS. If not using a custom image, leave this set to null. | `string` | `null` | no |
| <a name="input_vm_custom_image_rg_name"></a> [vm\_custom\_image\_rg\_name](#input\_vm\_custom\_image\_rg\_name) | Resource Group name where the custom VM image resides. Only valid if `vm_custom_image_name` is not null. | `string` | `null` | no |
| <a name="input_vm_image_offer"></a> [vm\_image\_offer](#input\_vm\_image\_offer) | Offer of the VM image. | `string` | `"0001-com-ubuntu-server-jammy"` | no |
| <a name="input_vm_image_publisher"></a> [vm\_image\_publisher](#input\_vm\_image\_publisher) | Publisher of the VM image. | `string` | `"Canonical"` | no |
| <a name="input_vm_image_sku"></a> [vm\_image\_sku](#input\_vm\_image\_sku) | SKU of the VM image. | `string` | `"22_04-lts-gen2"` | no |
| <a name="input_vm_image_version"></a> [vm\_image\_version](#input\_vm\_image\_version) | Version of the VM image. | `string` | `"latest"` | no |
| <a name="input_vm_os_distro"></a> [vm\_os\_distro](#input\_vm\_os\_distro) | OS distribution type for the Nomad VM. Choose from `Ubuntu`, `RHEL`, or `CentOS`. | `string` | `"Ubuntu"` | no |
| <a name="input_vm_size"></a> [vm\_size](#input\_vm\_size) | Azure VM size for Nomad VMs. | `string` | `"Standard_D2s_v3"` | no |
| <a name="input_vm_sku"></a> [vm\_sku](#input\_vm\_sku) | SKU for VM size for the VMSS. | `string` | `"Standard_D2s_v5"` | no |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_nomad_cli_config"></a> [nomad\_cli\_config](#output\_nomad\_cli\_config) | Environment variables to configure the nomad CLI |
| <a name="output_nomad_url"></a> [nomad\_url](#output\_nomad\_url) | URL to access Nomad application based on value of `nomad_fqdn` input. |
<!-- END_TF_DOCS -->
